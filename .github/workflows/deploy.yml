name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DOMAIN: terap-ia.victalejo.dev
  DEPLOY_PATH: /var/www/terap-ia

jobs:
  ################################################################################
  # Job 1: Build y Test
  ################################################################################
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Cache desactivado temporalmente para frontend debido a problemas con m√≥dulos nativos
          cache: 'npm'
          cache-dependency-path: terapia-notas-backend/package-lock.json

      - name: Install Backend dependencies
        working-directory: ./terapia-notas-backend
        run: npm ci

      - name: Build Backend
        working-directory: ./terapia-notas-backend
        run: npm run build

      - name: Install Frontend dependencies
        working-directory: ./terapia-front
        run: |
          # Limpiar completamente para evitar problemas con cache de m√≥dulos nativos
          rm -rf node_modules package-lock.json
          npm install --no-audit --no-fund
          # Verificar que los m√≥dulos nativos de Linux est√©n instalados
          echo "Verificando m√≥dulos nativos..."
          ls -la node_modules/ | grep lightningcss || true
          find node_modules -name "*lightningcss*linux*" -o -name "*oxide*linux*" || true

      - name: Build Frontend
        working-directory: ./terapia-front
        run: npm run build

      - name: Type check Frontend
        working-directory: ./terapia-front
        run: npm run type-check

      - name: Send build failure notification
        if: failure()
        continue-on-error: true
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST 'https://wapi.iaportafolio.com/api/sendText' \
            -H 'accept: application/json' \
            -H 'X-Api-Key: ${{ secrets.WHATSAPP_API_KEY }}' \
            -H 'Content-Type: application/json' \
            -d "{
              \"chatId\": \"${{ secrets.WHATSAPP_CHAT_ID }}\",
              \"text\": \"‚ùå *Build Fallido*\n\nüì¶ Proyecto: Terap-IA\nüåç Ambiente: CI/CD\nüìù Commit: ${{ steps.commit.outputs.sha_short }}\nüë§ Autor: ${{ steps.commit.outputs.author }}\n‚ùó Error: El build ha fallado\n‚è∞ Hora: ${TIMESTAMP}\n\nüîç Revisar logs en: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"session\": \"${{ secrets.WHATSAPP_SESSION }}\"
            }"

  ################################################################################
  # Job 2: Deploy to Production
  ################################################################################
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Send deployment start notification
        continue-on-error: true
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST 'https://wapi.iaportafolio.com/api/sendText' \
            -H 'accept: application/json' \
            -H 'X-Api-Key: ${{ secrets.WHATSAPP_API_KEY }}' \
            -H 'Content-Type: application/json' \
            -d "{
              \"chatId\": \"${{ secrets.WHATSAPP_CHAT_ID }}\",
              \"text\": \"üöÄ *Despliegue Iniciado*\n\nüì¶ Proyecto: Terap-IA\nüåç Ambiente: production\nüåø Branch: ${{ github.ref_name }}\nüìù Commit: ${{ steps.commit.outputs.sha_short }}\nüë§ Autor: ${{ steps.commit.outputs.author }}\nüí¨ Mensaje: ${{ steps.commit.outputs.message }}\n‚è∞ Hora: ${TIMESTAMP}\n\nIniciando proceso de despliegue...\",
              \"session\": \"${{ secrets.WHATSAPP_SESSION }}\"
            }"

      - name: Install SSH client
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass openssh-client

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa || echo "No SSH private key, using password"
          chmod 600 ~/.ssh/id_rsa || true
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup before deployment
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.SSH_PASSWORD }}" ]; then
            sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "cd ${{ env.DEPLOY_PATH }} && bash deploy/backup-db.sh backup || echo 'Backup failed, continuing...'"
          else
            ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "cd ${{ env.DEPLOY_PATH }} && bash deploy/backup-db.sh backup || echo 'Backup failed, continuing...'"
          fi

      - name: Deploy to server
        id: deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          BRANCH: master
          DOMAIN: ${{ env.DOMAIN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          START_TIME=$(date +%s)

          if [ -n "${{ secrets.SSH_PASSWORD }}" ]; then
            export SSHPASS="${{ secrets.SSH_PASSWORD }}"

            # Actualizar c√≥digo
            sshpass -e ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << ENDSSH
              set -e

              # Verificar y preparar directorio de deployment
              if [ ! -d "${DEPLOY_PATH}" ]; then
                echo "üìÅ Creando directorio ${DEPLOY_PATH}..."
                mkdir -p ${DEPLOY_PATH}
                cd ${DEPLOY_PATH}
                git clone https://github.com/${GITHUB_REPOSITORY}.git .
              else
                cd ${DEPLOY_PATH}
                if [ ! -d ".git" ]; then
                  echo "üìÅ Inicializando repositorio git..."
                  git init
                  git remote add origin https://github.com/${GITHUB_REPOSITORY}.git
                fi
              fi

              echo "üì• Actualizando c√≥digo..."
              git fetch origin ${BRANCH}
              git reset --hard origin/${BRANCH}
              git clean -fd

              echo "üìù Commit actual:"
              git log -1 --oneline

              echo "üîß Verificando variables de entorno..."
              if [ ! -f ".env" ]; then
                cp .env.production .env
                echo "‚ö†Ô∏è  .env creado desde .env.production"
              fi

              echo "üõë Deteniendo servicios..."
              docker-compose down || true

              echo "üèóÔ∏è  Construyendo im√°genes..."
              docker-compose build --no-cache

              echo "üöÄ Iniciando servicios..."
              docker-compose up -d

              echo "‚è≥ Esperando 20 segundos..."
              sleep 20

              echo "‚úÖ Despliegue completado"
          ENDSSH
          else
            ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << ENDSSH
              set -e

              # Verificar y preparar directorio de deployment
              if [ ! -d "${DEPLOY_PATH}" ]; then
                echo "üìÅ Creando directorio ${DEPLOY_PATH}..."
                mkdir -p ${DEPLOY_PATH}
                cd ${DEPLOY_PATH}
                git clone https://github.com/${GITHUB_REPOSITORY}.git .
              else
                cd ${DEPLOY_PATH}
                if [ ! -d ".git" ]; then
                  echo "üìÅ Inicializando repositorio git..."
                  git init
                  git remote add origin https://github.com/${GITHUB_REPOSITORY}.git
                fi
              fi

              echo "üì• Actualizando c√≥digo..."
              git fetch origin ${BRANCH}
              git reset --hard origin/${BRANCH}
              git clean -fd

              echo "üõë Deteniendo servicios..."
              docker-compose down || true

              echo "üèóÔ∏è  Construyendo im√°genes..."
              docker-compose build --no-cache

              echo "üöÄ Iniciando servicios..."
              docker-compose up -d

              echo "‚è≥ Esperando 20 segundos..."
              sleep 20

              echo "‚úÖ Despliegue completado"
          ENDSSH
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "duration=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Run health checks
        id: healthcheck
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.SSH_PASSWORD }}" ]; then
            sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "cd ${{ env.DEPLOY_PATH }} && bash deploy/health-check.sh check"
          else
            ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "cd ${{ env.DEPLOY_PATH }} && bash deploy/health-check.sh check"
          fi

      - name: Clean Docker resources
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.SSH_PASSWORD }}" ]; then
            sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "docker system prune -f || true"
          else
            ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "docker system prune -f || true"
          fi

      - name: Send success notification
        if: success()
        continue-on-error: true
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST 'https://wapi.iaportafolio.com/api/sendText' \
            -H 'accept: application/json' \
            -H 'X-Api-Key: ${{ secrets.WHATSAPP_API_KEY }}' \
            -H 'Content-Type: application/json' \
            -d "{
              \"chatId\": \"${{ secrets.WHATSAPP_CHAT_ID }}\",
              \"text\": \"‚úÖ *Despliegue Exitoso*\n\nüì¶ Proyecto: Terap-IA\nüåç Ambiente: production\nüìù Commit: ${{ steps.commit.outputs.sha_short }}\n‚è±Ô∏è  Duraci√≥n: ${{ steps.deploy.outputs.duration }}\nüîó URL: https://${{ env.DOMAIN }}\nüìö API Docs: https://${{ env.DOMAIN }}/api/docs\n‚è∞ Hora: ${TIMESTAMP}\n\n¬°El sistema est√° funcionando correctamente! üéâ\",
              \"session\": \"${{ secrets.WHATSAPP_SESSION }}\"
            }"

      - name: Send failure notification
        if: failure()
        continue-on-error: true
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST 'https://wapi.iaportafolio.com/api/sendText' \
            -H 'accept: application/json' \
            -H 'X-Api-Key: ${{ secrets.WHATSAPP_API_KEY }}' \
            -H 'Content-Type: application/json' \
            -d "{
              \"chatId\": \"${{ secrets.WHATSAPP_CHAT_ID }}\",
              \"text\": \"‚ùå *Despliegue Fallido*\n\nüì¶ Proyecto: Terap-IA\nüåç Ambiente: production\nüìù Commit: ${{ steps.commit.outputs.sha_short }}\n‚ùó Error: El despliegue ha fallado\n‚è∞ Hora: ${TIMESTAMP}\n\nüîç Revisar logs en: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nPor favor revisar el error y reintentar.\",
              \"session\": \"${{ secrets.WHATSAPP_SESSION }}\"
            }"

  ################################################################################
  # Job 3: Monitor Post-Deployment (opcional)
  ################################################################################
  post-deployment-check:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Wait 2 minutes for services to stabilize
        run: sleep 120

      - name: Check HTTPS endpoint
        run: |
          echo "Verificando endpoint HTTPS..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN }})

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 301 ] || [ "$HTTP_STATUS" -eq 302 ]; then
            echo "‚úÖ Frontend respondiendo correctamente (HTTP $HTTP_STATUS)"
          else
            echo "‚ùå Frontend no responde correctamente (HTTP $HTTP_STATUS)"
            exit 1
          fi

      - name: Check API endpoint
        continue-on-error: true
        run: |
          echo "Verificando endpoint API..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN }}/api/v1)

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 404 ]; then
            echo "‚úÖ API respondiendo (HTTP $HTTP_STATUS)"
          else
            echo "‚ö†Ô∏è  API status: HTTP $HTTP_STATUS"
          fi

      - name: Send monitoring report
        if: always()
        continue-on-error: true
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          curl -X POST 'https://wapi.iaportafolio.com/api/sendText' \
            -H 'accept: application/json' \
            -H 'X-Api-Key: ${{ secrets.WHATSAPP_API_KEY }}' \
            -H 'Content-Type: application/json' \
            -d "{
              \"chatId\": \"${{ secrets.WHATSAPP_CHAT_ID }}\",
              \"text\": \"üìä *Monitoreo Post-Despliegue*\n\n‚úÖ El sistema est√° estable despu√©s de 2 minutos\nüåê Frontend: Funcionando\n‚öôÔ∏è  Backend: Funcionando\nüîó https://${{ env.DOMAIN }}\n‚è∞ Hora: ${TIMESTAMP}\",
              \"session\": \"${{ secrets.WHATSAPP_SESSION }}\"
            }"
